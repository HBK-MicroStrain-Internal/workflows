name: CMake Preset Workflow Base

on:
  workflow_call:
    inputs:
      job_name:
        description: Name of the job to display in the GitHub UI
        type: string
        required: true
        default: ''

      runner_name:
        description: Name of the runner to run this workflow on
        type: string
        required: true
        default: ''

      preset_prefix:
        description: Prefix which is added to all preset names like msvc-2022-x64
        type: string
        required: true
        default: ''

      preset:
        description: The preset sub-type used for all presets. I.E. 'static' for the static preset
        type: string
        default: ''

      unit_test:
        description: Enable unit testing
        type: boolean
        default: false

      integration_test:
        description: Enable integration testing
        type: boolean
        default: false

      debug:
        description: Enable debug builds
        type: boolean
        default: false

      debug_configure_preset_name:
        description: Name of the CMake configure preset to use for debug builds
        type: string
        default: ''

      debug_build_preset_name:
        description: Name of the CMake build preset to use for the debug library/application
        type: string
        default: ''

      debug_unit_test_build_preset_name:
        description: Name of the CMake build preset to use for the debug unit tests
        type: string
        default: ''

      debug_unit_test_preset_name:
        description: Name of the CTest preset to use to run debug unit tests
        type: string
        default: ''

      debug_integration_test_build_preset_name:
        description: Name of the CMake build preset to use for the debug integration tests
        type: string
        default: ''

      debug_integration_test_preset_name:
        description: Name of the CTest preset to use to run debug integration tests
        type: string
        default: ''

      release:
        description: Enable release builds
        type: boolean
        default: false

      release_configure_preset_name:
        description: Name of the CMake configure preset to use for release builds
        type: string
        default: ''

      release_build_preset_name:
        description: Name of the CMake build preset to use for the release library/application
        type: string
        default: ''

      release_unit_test_build_preset_name:
        description: Name of the CMake build preset to use for the release unit tests
        type: string
        default: ''

      release_unit_test_preset_name:
        description: Name of the CTest preset to use to run release unit tests
        type: string
        default: ''

      release_integration_test_build_preset_name:
        description: Name of the CMake build preset to use for the release integration tests
        type: string
        default: ''

      release_integration_test_preset_name:
        description: Name of the CTest preset to use to run release integration tests
        type: string
        default: ''

      debug_package_preset_name:
        description: Name of the CMake package preset to use for the debug package
        type: string
        default: ''

      release_package_preset_name:
        description: Name of the CMake package preset to use for the release package
        type: string
        default: ''

      combined_package_preset_name:
        description: Name of the CMake package preset to use for the combined debug & release package
        type: string
        default: ''

      artifact_match_pattern:
        description: Pattern to match for artifacts to upload
        type: string
        default: '*.zip'

jobs:
  workflow:
    name: "${{ inputs.job_name }}"
    runs-on: ${{ inputs.runner_name }}

    steps:
      - name: "Handle Inputs"
        id: handle_inputs
        shell: bash
        run: |
          # Combine preset names for use in the workflow
          # This prepends the preset prefix to the preset name

          echo "validation_prefix=${{ inputs.preset_prefix }}-${{ inputs.preset }}" >> $GITHUB_OUTPUT


          # Create the debug preset options

          echo "debug_configure_preset_name=${{ inputs.preset_prefix }}-${{ inputs.preset }}${{ inputs.debug_configure_preset_name }}" >> $GITHUB_OUTPUT

          echo "debug_build_preset_name=${{ inputs.preset_prefix }}-${{ inputs.preset }}${{ inputs.debug_build_preset_name }}" >> $GITHUB_OUTPUT

          echo "debug_unit_test_build_preset_name=${{ inputs.preset_prefix }}-${{ inputs.debug_unit_test_build_preset_name }}" >> $GITHUB_OUTPUT
          echo "debug_unit_test_preset_name=${{ inputs.preset_prefix }}-${{ inputs.debug_unit_test_preset_name }}" >> $GITHUB_OUTPUT

          echo "debug_integration_test_build_preset_name=${{ inputs.preset_prefix }}-${{ inputs.debug_integration_test_build_preset_name }}" >> $GITHUB_OUTPUT
          echo "debug_integration_test_preset_name=${{ inputs.preset_prefix }}-${{ inputs.debug_integration_test_preset_name }}" >> $GITHUB_OUTPUT

          echo "debug_package_preset_name=${{ inputs.preset_prefix }}-${{ inputs.preset }}${{ inputs.debug_package_preset_name }}" >> $GITHUB_OUTPUT


          # Create the release preset options

          echo "release_configure_preset_name=${{ inputs.preset_prefix }}-${{ inputs.preset }}${{ inputs.release_configure_preset_name }}" >> $GITHUB_OUTPUT

          echo "release_build_preset_name=${{ inputs.preset_prefix }}-${{ inputs.preset }}${{ inputs.release_build_preset_name }}" >> $GITHUB_OUTPUT

          echo "release_unit_test_build_preset_name=${{ inputs.preset_prefix }}-${{ inputs.release_unit_test_build_preset_name }}" >> $GITHUB_OUTPUT
          echo "release_unit_test_preset_name=${{ inputs.preset_prefix }}-${{ inputs.release_unit_test_preset_name }}" >> $GITHUB_OUTPUT

          echo "release_integration_test_build_preset_name=${{ inputs.preset_prefix }}-${{ inputs.release_integration_test_build_preset_name }}" >> $GITHUB_OUTPUT
          echo "release_integration_test_preset_name=${{ inputs.preset_prefix }}-${{ inputs.release_integration_test_preset_name }}" >> $GITHUB_OUTPUT

          echo "release_package_preset_name=${{ inputs.preset_prefix }}-${{ inputs.preset }}${{ inputs.release_package_preset_name }}" >> $GITHUB_OUTPUT


          # Create Both debug and release preset options

          echo "combined_package_preset_name=${{ inputs.preset_prefix }}-${{ inputs.preset }}${{ inputs.combined_package_preset_name }}" >> $GITHUB_OUTPUT

      - name: "Validate Inputs"
        shell: bash
        run: |
          # Generic options

          if [ -z "${{ inputs.preset_prefix }}" ]; then
            echo "A preset prefix is required using 'preset_prefix'"
            exit 1
          fi


          # Debug options

          if [ "${{ inputs.debug }}" == "true" ]; then
            if [ -z "${{ steps.handle_inputs.outputs.debug_configure_preset_name }}" ] &&
              [ "${{ steps.handle_inputs.outputs.debug_configure_preset_name }}" == "${{ steps.handle_inputs.outputs.validation_prefix }}" ]; then
              echo "A debug configure preset is required using 'debug_configure_preset_name'"
              exit 1
            fi

            if [ -z "${{ steps.handle_inputs.outputs.debug_build_preset_name }}" ] &&
              [ "${{ steps.handle_inputs.outputs.debug_build_preset_name }}" == "${{ steps.handle_inputs.outputs.validation_prefix }}" ]; then
              echo "A debug build preset is required using 'debug_build_preset_name'"
              exit 1
            fi

            if [ "${{ inputs.unit_test }}" == "true" ]; then
              if [ -z "${{ steps.handle_inputs.outputs.debug_unit_test_build_preset_name }}" ] &&
                [ "${{ steps.handle_inputs.outputs.debug_unit_test_build_preset_name }}" == "${{ inputs.preset_prefix }}" ]; then
                echo "A unit test debug build preset is required using 'debug_unit_test_build_preset_name'"
                exit 1
              fi

              if [ -z "${{ steps.handle_inputs.outputs.debug_unit_test_preset_name }}" ] &&
                [ "${{ steps.handle_inputs.outputs.debug_unit_test_preset_name }}" == "${{ inputs.preset_prefix }}" ]; then
                echo "A unit test debug preset is required using 'debug_unit_test_preset_name'"
                exit 1
              fi
            fi

            if [ "${{ inputs.integration_test }}" == "true" ]; then
              if [ -z "${{ steps.handle_inputs.outputs.debug_integration_test_build_preset_name }}" ] &&
                [ "${{ steps.handle_inputs.outputs.debug_integration_test_build_preset_name }}" == "${{ inputs.preset_prefix }}" ]; then
                echo "An integration test debug build preset is required using 'debug_integration_test_build_preset_name'"
                exit 1
              fi

              if [ -z "${{ steps.handle_inputs.outputs.debug_integration_test_preset_name }}" ] &&
                [ "${{ steps.handle_inputs.outputs.debug_integration_test_preset_name }}" == "${{ inputs.preset_prefix }}" ]; then
                echo "An integration test debug preset is required using 'debug_integration_test_preset_name'"
                exit 1
              fi
            fi

            if [ -z "${{ steps.handle_inputs.outputs.debug_package_preset_name }}" ] &&
              [ "${{ steps.handle_inputs.outputs.debug_package_preset_name }}" == "${{ steps.handle_inputs.outputs.validation_prefix }}" ]; then
              echo "A debug package preset is required using 'debug_package_preset_name'"
              exit 1
            fi
          fi


          # Release options

          if [ "${{ inputs.release }}" == "true" ]; then
            if [ -z "${{ steps.handle_inputs.outputs.release_configure_preset_name }}" ] &&
              [ "${{ steps.handle_inputs.outputs.release_configure_preset_name }}" == "${{ steps.handle_inputs.outputs.validation_prefix }}" ]; then
              echo "A release configure preset is required using 'release_configure_preset_name'"
              exit 1
            fi

            if [ -z "${{ steps.handle_inputs.outputs.release_build_preset_name }}" ] &&
              [ "${{ steps.handle_inputs.outputs.release_build_preset_name }}" == "${{ steps.handle_inputs.outputs.validation_prefix }}" ]; then
              echo "A release build preset is required using 'release_build_preset_name'"
              exit 1
            fi

            if [ "${{ inputs.unit_test }}" == "true" ]; then
              if [ -z "${{ steps.handle_inputs.outputs.release_unit_test_build_preset_name }}" ] &&
                [ "${{ steps.handle_inputs.outputs.release_unit_test_build_preset_name }}" == "${{ inputs.preset_prefix }}" ]; then
                echo "A unit test release build preset is required using 'release_unit_test_build_preset_name'"
                exit 1
              fi

              if [ -z "${{ steps.handle_inputs.outputs.release_unit_test_preset_name }}" ] &&
                [ "${{ steps.handle_inputs.outputs.release_unit_test_preset_name }}" == "${{ inputs.preset_prefix }}" ]; then
                echo "A unit test release preset is required using 'release_unit_test_preset_name'"
                exit 1
              fi
            fi

            if [ "${{ inputs.integration_test }}" == "true" ]; then
              if [ -z "${{ steps.handle_inputs.outputs.release_integration_test_build_preset_name }}" ] &&
                [ "${{ steps.handle_inputs.outputs.release_integration_test_build_preset_name }}" == "${{ inputs.preset_prefix }}" ]; then
                echo "An integration test release build preset is required using 'release_integration_test_build_preset_name'"
                exit 1
              fi

              if [ -z "${{ steps.handle_inputs.outputs.release_integration_test_preset_name }}" ] &&
                [ "${{ steps.handle_inputs.outputs.release_integration_test_preset_name }}" == "${{ inputs.preset_prefix }}" ]; then
                echo "An integration test release preset is required using 'release_integration_test_preset_name'"
                exit 1
              fi
            fi

            if [ -z "${{ steps.handle_inputs.outputs.release_package_preset_name }}" ] &&
              [ "${{ steps.handle_inputs.outputs.release_package_preset_name }}" == "${{ steps.handle_inputs.outputs.validation_prefix }}" ]; then
              echo "A release package preset is required using 'release_package_preset_name'"
              exit 1
            fi
          fi


          # Both Debug and Release options

          if [ "${{ inputs.debug }}" == "true" ] && [ "${{ inputs.release }}" == "true" ]; then
            if [ -z "${{ steps.handle_inputs.outputs.combined_package_preset_name }}" ] &&
              [ "${{ steps.handle_inputs.outputs.combined_package_preset_name }}" == "${{ steps.handle_inputs.outputs.validation_prefix }}" ]; then
              echo "A debug and release package preset is required using 'combined_package_preset_name'"
              exit 1
            fi
          fi

      - name: "Checkout"
        uses: HBK-MicroStrain-Internal/actions/checkout@main

      - name: "Configure (Debug)"
        if: >-
          ${{
            inputs.debug
          }}
        uses: HBK-MicroStrain-Internal/actions/cmake-configure@main
        with:
          preset_name: "${{ steps.handle_inputs.outputs.debug_configure_preset_name }}"

      - name: "Build (Debug)"
        if: >-
          ${{
            inputs.debug
          }}
        uses: HBK-MicroStrain-Internal/actions/cmake-build@main
        with:
          preset_name: "${{ steps.handle_inputs.outputs.debug_build_preset_name }}"

      - name: "Build Unit Test(s) (Debug)"
        if: >-
          ${{
            inputs.debug &&
            inputs.unit_test
          }}
        uses: HBK-MicroStrain-Internal/actions/cmake-build@main
        with:
          preset_name: "${{ steps.handle_inputs.outputs.debug_unit_test_build_preset_name }}"

      - name: "Run Unit Test(s) (Debug)"
        id: unit-test-debug
        if: >-
          ${{
            inputs.debug &&
            inputs.unit_test
          }}
        uses: HBK-MicroStrain-Internal/actions/cmake-test@main
        with:
          preset_name: "${{ steps.handle_inputs.outputs.debug_unit_test_preset_name }}"

      - name: "Unit Test Results (Debug)"
        # Upload results even for failed tests
        if: >-
          ${{
            always() &&
            (steps.unit-test-debug.outcome == 'success' ||
            steps.unit-test-debug.outcome == 'failure')
          }}
        uses: HBK-MicroStrain-Internal/actions/test-results@main
        with:
          display_name: "${{ inputs.job_name }} Unit Test(s) (Debug)"
          file_name: '*unit-test-results-Debug.xml'

      - name: "Build Integration Test(s) (Debug)"
        if: >-
          ${{
            inputs.debug &&
            inputs.integration_test
          }}
        uses: HBK-MicroStrain-Internal/actions/cmake-build@main
        with:
          preset_name: "${{ steps.handle_inputs.outputs.debug_integration_test_build_preset_name }}"

      - name: "Run Integration Test(s) (Debug)"
        id: integration-test-debug
        if: >-
          ${{
            inputs.debug &&
            inputs.integration_test
          }}
        uses: HBK-MicroStrain-Internal/actions/cmake-test@main
        with:
          preset_name: "${{ steps.handle_inputs.outputs.debug_integration_test_preset_name }}"

      - name: "Integration Test Results (Debug)"
        # Upload results even for failed tests
        if: >-
          ${{
            always() &&
            (steps.integration-test-debug.outcome == 'success' ||
            steps.integration-test-debug.outcome == 'failure')
          }}
        uses: HBK-MicroStrain-Internal/actions/test-results@main
        with:
          display_name: "${{ inputs.job_name }} Integration Test(s) (Debug)"
          file_name: '*integration-test-results-Debug.xml'

      - name: "Configure (Release)"
        if: >-
          ${{
            inputs.release
          }}
        uses: HBK-MicroStrain-Internal/actions/cmake-configure@main
        with:
          preset_name: "${{ steps.handle_inputs.outputs.release_configure_preset_name }}"

      - name: "Build (Release)"
        if: >-
          ${{
            inputs.release
          }}
        uses: HBK-MicroStrain-Internal/actions/cmake-build@main
        with:
          preset_name: "${{ steps.handle_inputs.outputs.release_build_preset_name }}"

      - name: "Build Unit Test(s) (Release)"
        if: >-
          ${{
            inputs.release &&
            inputs.unit_test
          }}
        uses: HBK-MicroStrain-Internal/actions/cmake-build@main
        with:
          preset_name: "${{ steps.handle_inputs.outputs.release_unit_test_build_preset_name }}"

      - name: "Run Unit Test(s) (Release)"
        id: unit-test-release
        if: >-
          ${{
            inputs.release &&
            inputs.unit_test
          }}
        uses: HBK-MicroStrain-Internal/actions/cmake-test@main
        with:
          preset_name: "${{ steps.handle_inputs.outputs.release_unit_test_preset_name }}"

      - name: "Unit Test Results (Release)"
        # Upload results even for failed tests
        if: >-
          ${{
            always() &&
            (steps.unit-test-release.outcome == 'success' ||
            steps.unit-test-release.outcome == 'failure')
          }}
        uses: HBK-MicroStrain-Internal/actions/test-results@main
        with:
          display_name: "${{ inputs.job_name }} Unit Test(s) (Release)"
          file_name: '*unit-test-results-Release.xml'

      - name: "Build Integration Test(s) (Release)"
        if: >-
          ${{
            inputs.release &&
            inputs.integration_test
          }}
        uses: HBK-MicroStrain-Internal/actions/cmake-build@main
        with:
          preset_name: "${{ steps.handle_inputs.outputs.release_integration_test_build_preset_name }}"

      - name: "Run Integration Test(s) (Release)"
        id: integration-test-release
        if: >-
          ${{
            inputs.release &&
            inputs.integration_test
          }}
        uses: HBK-MicroStrain-Internal/actions/cmake-test@main
        with:
          preset_name: "${{ steps.handle_inputs.outputs.release_integration_test_preset_name }}"

      - name: "Integration Test Results (Release)"
        # Upload results even for failed tests
        if: >-
          ${{
            always() &&
            (steps.integration-test-release.outcome == 'success' ||
            steps.integration-test-release.outcome == 'failure')
          }}
        uses: HBK-MicroStrain-Internal/actions/test-results@main
        with:
          display_name: "${{ inputs.job_name }} Integration Test(s) (Release)"
          file_name: '*integration-test-results-Release.xml'

      - name: "Package (Debug)"
        if: >-
          ${{
            inputs.debug &&
            !inputs.release
          }}
        uses: HBK-MicroStrain-Internal/actions/cmake-package@main
        with:
          preset_name: "${{ steps.handle_inputs.outputs.debug_package_preset_name }}"

      - name: "Package (Release)"
        if: >-
          ${{
            !inputs.debug &&
            inputs.release
          }}
        uses: HBK-MicroStrain-Internal/actions/cmake-package@main
        with:
          preset_name: "${{ steps.handle_inputs.outputs.release_package_preset_name }}"

      - name: "Package (Debug & Release)"
        if: >-
          ${{
            inputs.debug &&
            inputs.release
          }}
        uses: HBK-MicroStrain-Internal/actions/cmake-package@main
        with:
          preset_name: "${{ steps.handle_inputs.outputs.combined_package_preset_name }}"

      - name: "Archive Artifacts"
        uses: HBK-MicroStrain-Internal/actions/archive-artifacts@main
        with:
          artifact_name: "${{ inputs.job_name }}"
          file_name: "${{ inputs.artifact_match_pattern }}"
